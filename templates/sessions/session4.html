<section id="session4" class="content-section" style="display:none;">

    <div class="section-header-wrapper">
        <span class="section-badge">05</span>
        <h2 class="section-title-large">Cost & Performance</h2>
        <p class="section-subtitle">Session 5: Cost Management</p>
    </div>

    <div class="content-overview">
        <h4>In this Session</h4>
        <ul>
            <li><a href="#section-5-1">5.1 Pricing Models</a></li>
            <li><a href="#section-5-2">5.2 Reservations & Capacity</a></li>
            <li><a href="#section-5-3">5.3 Monitoring</a></li>
            <li><a href="#section-5-4">5.4 Query Cost Controls</a></li>
            <li><a href="#section-5-5">5.5 Storage Optimization</a></li>
            <li><a href="#section-5-6">5.6 Checklist</a></li>
        </ul>
    </div>

    <div class="topic-block">
        <div class="content-split">
            <div class="text-col">
                <h3 id="section-5-1">5.1 On-Demand vs Editions <a href="#session4" class="back-to-top">Top &uarr;</a>
                </h3>
                <p>Understanding the difference between On-Demand and Editions (Capacity-based)
                    pricing
                    is critical.</p>
                <div class="concept-card">
                    <h4>Pricing Models</h4>
                    <ul>
                        <li><strong>On-Demand:</strong> Pay per TB scanned. Great for flexibility.
                        </li>
                        <li><strong>Editions:</strong> Pay per Slot-Hour. 3 Tiers: Standard,
                            Enterprise,
                            Enterprise Plus.</li>
                        <li><strong>Physical Storage Pricing:</strong> Bill based on
                            <em>compressed</em>
                            bytes (40-60% savings).
                        </li>
                    </ul>
                </div>
            </div>
            <div class="visual-col">
                <div class="tech-card">
                    <h4>Pricing Tiers</h4>
                    <img src="{{ url_for('static', filename='images/bq_pricing_models_chart_1768817842723.png') }}"
                        alt="Pricing Models Comparison">
                    <p class="caption">Figure 10: BigQuery Pricing Models</p>
                </div>
            </div>
        </div>

    </div>



    <div class="topic-block">
        <div class="content-split">
            <div class="text-col">
                <h3 id="section-5-2">5.2 Reservations & Commitments <a href="#session4" class="back-to-top">Top
                        &uarr;</a></h3>
                <p>For predictable performance and cost, enterprise workloads use <strong>Capitalized Slot
                        Commitments</strong> (Editions) instead of On-Demand.</p>

                <div class="concept-card">
                    <h4>Capacity Planning (Slots)</h4>
                    <ul>
                        <li><strong>Commitment:</strong> You purchase a bucket of slots (e.g., 100 slots) for a term
                            (1 year/3 year) or flex (short-term).</li>
                        <li><strong>Reservations:</strong> You carve that bucket into pools (e.g., "Prod" gets 80,
                            "Test" gets 20).</li>
                        <li><strong>Assignments:</strong> You attach Google Cloud Projects, Folders, or Organizations to
                            a specific Reservation.</li>
                    </ul>
                </div>

                <div class="concept-card" style="margin-top: 16px; border-left-color: #F4B400;">
                    <h4 style="color: #F4B400;">Efficiency Features</h4>
                    <ul>
                        <li><strong>Fair Scheduling:</strong> Within a reservation, slots are distributed fairly among
                            active queries. If a query needs more and others are idle, it scales up.</li>
                        <li><strong>Idle Slot Sharing:</strong> If the "Prod" pool is idle, "Test" queries can
                            temporarily borrow those slots (and yield them back instantly when Prod wakes up).</li>
                    </ul>
                </div>
            </div>
            <div class="visual-col">
                <div class="tech-card">
                    <h4>Reservations & Idle Slots</h4>
                    <img src="{{ url_for('static', filename='images/reservations_slot_sharing.png') }}"
                        alt="Reservations and Idle Slot Sharing" class="zoomable-image">
                    <p class="caption">Figure 12: Projects allow Idle Slots to flow between Reservations.</p>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h4>Code Example: Capacity Monitoring</h4>
            <pre><code class="language-sql">-- Check Slot Usage by Reservation
SELECT
  reservation_id,
  period_start,
  SUM(slot_ms) / 1000 / 60 as slot_minutes_used
FROM
  `region-us`.INFORMATION_SCHEMA.JOBS_TIMELINE_BY_PROJECT
WHERE
    period_start > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 HOUR)
GROUP BY 1, 2
ORDER BY 2 DESC</code></pre>
        </div>
    </div>

    <div class="topic-block">
        <div class="content-split">
            <div class="text-col">
                <h3 id="section-5-3">5.3 Monitoring & Observability <a href="#session4" class="back-to-top">Top
                        &uarr;</a></h3>
                <p>Effective cost management requires visibility. BigQuery provides three layers of observability.</p>
                <div class="concept-card">
                    <h4>1. Admin Resource Charts</h4>
                    <p>Real-time view of <strong>Operational Health</strong>.
                    <ul>
                        <li><strong>Slot Utilization:</strong> See if you are hitting capacity limits (Slot Contention).
                        </li>
                        <li><strong>Job Concurrency:</strong> Track how many queries are running in parallel.</li>
                        <li><strong>Failed Jobs:</strong> Spike detection for broken pipelines.</li>
                    </ul>
                </div>

                <div class="concept-card" style="margin-top: 16px;">
                    <h4>2. Jobs Explorer & Cloud Monitoring</h4>
                    <ul>
                        <li><strong>Jobs Explorer:</strong> Drill down into specific queries. Filter by "Bytes
                            Billed" to find cost spikes or "Duration" to find slow queries.</li>
                        <li><strong>Cloud Monitoring:</strong> Create custom dashboards (e.g., Looker Studio) using
                            metrics like <code>slots/allocated</code> vs <code>slots/used</code>.</li>
                    </ul>
                </div>

                <div class="concept-card" style="margin-top: 16px; border-left-color: #34A853;">
                    <h4>3. Optimization & Cleanup (Deep Dive)</h4>
                    <p>Use <code>INFORMATION_SCHEMA</code> for granular analysis:</p>
                    <ul>
                        <li><strong>TABLE_STORAGE:</strong> Compare <code>ACTIVE_LOGICAL_BYTES</code> vs
                            <code>ACTIVE_PHYSICAL_BYTES</code> to see compression savings.
                        </li>
                        <li><strong>JOBS_TIMELINE:</strong> Visualize concurrency slots over time to find peak hours.
                        </li>
                        <li><strong>RESERVATIONS:</strong> Audit capacity commitments and assignments.</li>
                    </ul>
                </div>
            </div>
            <div class="visual-col">
                <div class="tech-card">
                    <h4>Monitoring Dashboard</h4>
                    <img src="{{ url_for('static', filename='images/monitoring_dashboard_ui.png') }}"
                        alt="BigQuery Monitoring Dashboard" class="zoomable-image">
                    <p class="caption">Figure 13: Operational Health Dashboard in Google Cloud Console.</p>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h4>Code Example: Identify Slot Contention</h4>
            <pre><code class="language-sql">-- Find queries that waited for slots
SELECT
  job_id,
  creation_time,
  total_slot_ms,
  -- Time spent waiting for meaningful work
  IF(total_slot_ms > 0, total_slot_ms / TIMESTAMP_DIFF(end_time, start_time, MILLISECOND), 0) as avg_slots
FROM `region-us`.INFORMATION_SCHEMA.JOBS_BY_PROJECT
WHERE 
  -- Look for jobs where wait time is high relative to execution
  job_type = 'QUERY'
ORDER BY total_slot_ms DESC
LIMIT 5</code></pre>
        </div>

        <div class="code-example">
            <h4>Code Example: Find Most Expensive Queries</h4>
            <pre><code class="language-sql">-- Identify top 5 costliest queries in the last 7 days
SELECT
  job_id,
  user_email,
  total_bytes_billed,
  creation_time
FROM
  `region-us`.INFORMATION_SCHEMA.JOBS_BY_PROJECT
WHERE
  creation_time > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
ORDER BY
  total_bytes_billed DESC
LIMIT 5;</code></pre>
        </div>

        <div class="code-example">
            <h4>Code Example: Storage Optimization Analysis</h4>
            <pre><code class="language-sql">-- Find tables with low compression ratios (Candidates for cleanup)
SELECT
  table_schema,
  table_name,
  -- Logical = Uncompressed, Physical = Compressed
  active_logical_bytes / POWER(1024, 3) as logical_gb,
  active_physical_bytes / POWER(1024, 3) as physical_gb,
  -- Calculate Compression Ratio
  SAFE_DIVIDE(active_logical_bytes, active_physical_bytes) as compression_ratio
FROM
  `region-us`.INFORMATION_SCHEMA.TABLE_STORAGE
WHERE
  active_logical_bytes > 0
ORDER BY
  physical_gb DESC
LIMIT 10;</code></pre>
        </div>
    </div>

    <!-- 5.4 Query Costs -->
    <div class="topic-block">
        <h3 id="section-5-4">5.4 Control Query Costs <a href="#session4" class="back-to-top">Top &uarr;</a></h3>
        <p>Enforce limits before users run expensive queries.</p>
        <div class="content-split">
            <div class="text-col">
                <div class="concept-card" style="border-left-color: #4285F4;">
                    <h4>Best Practices</h4>
                    <ul>
                        <li><strong>Max Bytes Billed:</strong> Set a strict limit (e.g., 100GB) on custom quota groups.
                            Queries exceeding this will fail instantly (no cost).</li>
                        <li><strong>Dry Runs:</strong> Always perform a <code>--dry_run</code> to validate schema and
                            see cost estimate.</li>
                        <li><strong>No SELECT *:</strong> Columnar storage means you pay for every column you select. Be
                            specific.</li>
                    </ul>
                </div>
            </div>
            <div class="visual-col">
                <div class="tech-card">
                    <h4>Query Controls</h4>
                    <img src="{{ url_for('static', filename='images/query_control_visual_1768985824562.png') }}"
                        alt="Query Cost Controls: Dry Run and Max Bytes Billed" class="zoomable-image">
                    <p class="caption">Figure 15: Validating costs before execution.</p>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h4>UI Tip: Cost Validation</h4>
            <p>In the BigQuery Console, "Dry Runs" are automatic. Look for the green checkmark in the top-right corner
                of the query editor.</p>
            <div
                style="background: #f8f9fa; border: 1px solid #dadce0; padding: 12px 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px; font-family: 'Roboto', sans-serif;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 13.41L17.59 5.82L19 7.23L10 17Z"
                        fill="#34A853" />
                </svg>
                <div style="display: flex; flex-direction: column;">
                    <span style="font-weight: 500; color: #3c4043;">This query will process 150.5 GB when run.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 5.5 Storage Optimization -->
    <div class="topic-block">
        <h3 id="section-5-5">5.5 Storage Optimization <a href="#session4" class="back-to-top">Top &uarr;</a></h3>
        <p>Don't pay for data you don't need or space you can compress.</p>
        <div class="content-split">
            <div class="visual-col">
                <div class="tech-card">
                    <h4>Storage Strategy</h4>
                    <img src="{{ url_for('static', filename='images/storage_optimization_visual_1768985639252.png') }}"
                        alt="Storage Billing Models: Logical vs Physical" class="zoomable-image">
                    <p class="caption">Figure 16: Physical billing saves 40-60% on compressed data.</p>
                </div>
            </div>
            <div class="text-col">
                <div class="concept-card" style="border-left-color: #FBBC04;">
                    <h4>Strategies</h4>
                    <ul>
                        <li><strong>Physical Billing:</strong> Switch datasets with high-compression data (JSON/Logs) to
                            Physical Billing.</li>
                        <li><strong>Table Expiration:</strong> Set default expiration (e.g., 7 days) for sandbox
                            datasets.</li>
                        <li><strong>Time Travel:</strong> Reduce window from 7 days to 2 days for non-critical tables if
                            using physical billing.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 5.6 Cost Checklist (Summary) -->
    <div class="topic-block">
        <h3 id="section-5-6">5.6 Optimization Checklist <a href="#session4" class="back-to-top">Top &uarr;</a></h3>
        <div class="tech-card" style="margin-bottom: 32px;">
            <h4>Optimisation Summary</h4>
            <img src="{{ url_for('static', filename='images/cost_optimization_checklist_1768985401639.png') }}"
                alt="Cost Optimization Checklist" class="zoomable-image">
            <p class="caption">Figure 14: Practical steps to reduce costs.</p>
        </div>
    </div>
</section>